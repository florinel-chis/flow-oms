# Configuration Guide

Complete configuration reference for FlowOMS.

## Environment Variables

### Application Settings

```env
APP_NAME="FlowOMS"
APP_ENV=production
APP_KEY=base64:... # Generated by php artisan key:generate
APP_DEBUG=false
APP_TIMEZONE=UTC
APP_URL=https://your-domain.com
```

### Database Configuration

**MySQL (Production)**
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=flowoms
DB_USERNAME=flowoms_user
DB_PASSWORD=secure_password
```

**SQLite (Development)**
```env
DB_CONNECTION=sqlite
DB_DATABASE=/absolute/path/to/database.sqlite
```

### Queue Configuration

**Development (Sync)**
```env
QUEUE_CONNECTION=sync
```

**Production (Redis)**
```env
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### Mail Configuration

**SMTP**
```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="noreply@flowoms.com"
MAIL_FROM_NAME="${APP_NAME}"
```

**Mailgun**
```env
MAIL_MAILER=mailgun
MAILGUN_DOMAIN=mg.your-domain.com
MAILGUN_SECRET=key-...
```

### Filament Admin

```env
FILAMENT_DOMAIN=your-domain.com
FILAMENT_PATH=/admin
```

## Tenant Configuration

### Creating a Tenant

```php
use App\Models\Tenant;

$tenant = Tenant::create([
    'name' => 'Demo Company',
    'slug' => 'demo',
]);
```

### Tenant URL Structure

```
https://your-domain.com/admin/{tenant-slug}/dashboard
https://your-domain.com/admin/demo/orders
```

### Assigning Users to Tenants

```php
$user->tenants()->attach($tenant->id);
```

## Magento Store Configuration

### Adding a Magento Store

Via Filament admin panel:
1. Navigate to **Magento Stores**
2. Click **New Magento Store**
3. Fill in details:
   - **Name**: Store identifier
   - **Base URL**: `https://your-magento-store.com`
   - **API Token**: Integration token from Magento
   - **Tenant**: Select owning tenant

### Generating Magento API Token

In Magento Admin:
1. **System** → **Extensions** → **Integrations**
2. Click **Add New Integration**
3. Set name: "FlowOMS Integration"
4. Go to **API** tab
5. Select resources: Orders, Invoices, Shipments
6. Save and activate
7. Copy **Access Token**

### Testing Magento Connection

```bash
php artisan magento:sync-orders --store-id=1 --test
```

## SLA Configuration

### Default SLA Rules

Via Settings in Filament admin:

**Dashboard Settings:**
- `unpaid_warning_threshold`: 10 (show warning when >10 unpaid)
- `unpaid_info_threshold`: 5 (show info when >5 unpaid)
- `target_sla_compliance`: 95 (target percentage)

**Ready to Ship Settings:**
- `ready_to_ship_payment_statuses`: `["paid","authorized"]`
- `ready_to_ship_order_statuses`: `["processing","pending"]`
- `ready_to_ship_exclude_has_shipment`: true

### Custom SLA Calculation

Edit `app/Services/Sla/SlaCalculatorService.php`:

```php
public function calculateDeadline(Order $order): Carbon
{
    // Custom logic based on order priority, shipping method, etc.
    return now()->addHours(24);
}
```

## API Configuration

### Sanctum Token Generation

```php
$user = User::find(1);
$token = $user->createToken('api-client', ['*'], $user->tenant_id);
echo $token->plainTextToken; // Store this securely
```

### Rate Limiting

Edit `bootstrap/app.php`:

```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->throttleApi('60,1'); // 60 requests per minute
})
```

### CORS Configuration

Edit `config/cors.php`:

```php
return [
    'paths' => ['api/*'],
    'allowed_origins' => ['https://your-frontend.com'],
    'allowed_methods' => ['GET', 'POST', 'PUT', 'DELETE'],
    'allowed_headers' => ['*'],
];
```

## Notification Configuration

### Email Templates

Templates located in `resources/views/emails/`:
- `unpaid-order-reminder.blade.php`
- `delayed-shipment-notification.blade.php`
- `sla-breach-notification.blade.php`

### Notification Settings

```php
// In database seeder or via admin panel
Setting::set('notifications', 'unpaid_reminder_days', 7);
Setting::set('notifications', 'send_sla_alerts', true);
```

## Queue Workers

### Starting Workers

**Development:**
```bash
php artisan queue:work
```

**Production with Horizon:**
```bash
php artisan horizon
```

### Supervisor Configuration

`/etc/supervisor/conf.d/flowoms-worker.conf`:
```ini
[program:flowoms-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/flowoms/artisan queue:work --sleep=3 --tries=3
autostart=true
autorestart=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/flowoms/storage/logs/worker.log
```

## Scheduler Configuration

### Cron Entry

Add to crontab:
```bash
* * * * * cd /path/to/flowoms && php artisan schedule:run >> /dev/null 2>&1
```

### Scheduled Tasks

Edit `routes/console.php`:

```php
Schedule::job(new SyncMagentoOrdersJob)->everyThirtyMinutes();
Schedule::job(new MonitorSlaBreachesJob)->hourly();
Schedule::command('unpaid:process')->daily();
```

## Performance Configuration

### Optimization Commands

```bash
# Production optimization
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan filament:assets

# Clear caches
php artisan optimize:clear
```

### Database Indexes

Key indexes already defined in migrations:
- `orders`: (tenant_id, status), (tenant_id, ordered_at)
- `shipments`: (tenant_id, status), (magento_shipment_id)
- `api_logs`: (tenant_id, created_at)

## Security Configuration

### Force HTTPS

In `app/Providers/AppServiceProvider.php`:

```php
if ($this->app->environment('production')) {
    URL::forceScheme('https');
}
```

### Session Security

Edit `.env`:
```env
SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_SECURE_COOKIE=true
SESSION_SAME_SITE=lax
```

## Backup Configuration

### Database Backup

```bash
# Create backup
php artisan backup:run

# Restore from backup
mysql flowoms < backup.sql
```

### Automated Backups

Use Laravel Backup package or database snapshots via hosting provider.

## Monitoring Configuration

### Laravel Telescope (Development)

```bash
composer require laravel/telescope --dev
php artisan telescope:install
php artisan migrate
```

Access at: `/telescope`

### Application Logs

Configured in `config/logging.php`:
- Daily rotating logs
- Stored in `storage/logs/`
- Error notifications via email

## Environment-Specific Settings

### Local Development

```env
APP_ENV=local
APP_DEBUG=true
QUEUE_CONNECTION=sync
MAIL_MAILER=log
```

### Staging

```env
APP_ENV=staging
APP_DEBUG=true
QUEUE_CONNECTION=redis
```

### Production

```env
APP_ENV=production
APP_DEBUG=false
QUEUE_CONNECTION=redis
HORIZON_ENABLED=true
```

## Troubleshooting

### Clear All Caches

```bash
php artisan optimize:clear
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear
```

### Permission Issues

```bash
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### Queue Not Processing

```bash
# Check queue worker status
php artisan queue:work --once

# Restart Horizon
php artisan horizon:terminate
```

## Further Reading

- [Architecture Overview](architecture.md)
- [Magento Integration](integrations/magento-integration.md)
- [API Documentation](api/overview.md)
